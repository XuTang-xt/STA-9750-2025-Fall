---
title: "Mini-Project #03: NYC Street Trees and Council Districts"
author: "Your Name"
format:
  html:
    toc: true
    number-sections: true
    theme: cosmo
execute:
  echo: true
  warning: false
  message: false
  cache: true
---

```{r setup}
# Global chunk options
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 6
)

# Packages
library(sf)
library(tidyverse)
library(httr2)
library(purrr)

# Data directory
dir.create("data/mp03", showWarnings = FALSE, recursive = TRUE)
```

# Task 1: Data Acquisition and Preparation

## 1.1 City Council District Boundaries (NYC Open Data)

```{r council}
download_council_districts <- function(
  dest_dir = "data/mp03",
  zip_url  = "https://data.cityofnewyork.us/api/geospatial/mkqi-d8x3?method=export&format=Shapefile",
  zip_name = "nyc_council_districts_open_data.zip"
) {
  dir.create(dest_dir, showWarnings = FALSE, recursive = TRUE)
  zip_path <- file.path(dest_dir, zip_name)

  # Download shapefile zip from NYC Open Data if not already present
  if (!file.exists(zip_path)) {
    message("Downloading City Council shapefile zip from NYC Open Data ...")
    resp <- httr2::request(zip_url) |>
      httr2::req_perform()
    writeBin(httr2::resp_body_raw(resp), zip_path)
  } else {
    message("Zip already exists, skipping download.")
  }

  # List files and check for any .shp
  all_files <- list.files(dest_dir, full.names = TRUE)
  has_shp   <- any(tools::file_ext(all_files) == "shp")

  # If no shapefile yet, unzip
  if (!has_shp) {
    message("Unzipping shapefile ...")
    unzip(zip_path, exdir = dest_dir)
    all_files <- list.files(dest_dir, full.names = TRUE)
  }

  shp_files <- all_files[tools::file_ext(all_files) == "shp"]
  if (length(shp_files) == 0) {
    stop("Could not find .shp file in ", dest_dir)
  }

  shp_file <- shp_files[1]
  nycc_raw <- sf::st_read(shp_file, quiet = TRUE)

  # Find the council district column and rename it to COUNDIST
  nm       <- names(nycc_raw)
  nm_lower <- tolower(nm)
  possible_lower <- c("coun_dist", "coundist", "council", "council_d",
                      "councildis", "council_district")
  idx <- which(nm_lower %in% possible_lower)

  if (length(idx) == 0) {
    stop("Could not find council district column. Columns are: ",
         paste(nm, collapse = ", "))
  }

  names(nycc_raw)[idx[1]] <- "COUNDIST"

  # Transform to WGS84
  nycc_wgs84 <- sf::st_transform(nycc_raw, "WGS84")

  # Compute district area in square meters for density calculations
  nycc_wgs84$area_m2 <- as.numeric(sf::st_area(nycc_wgs84))

  nycc_wgs84
}

nyc_council <- download_council_districts()
nyc_council
```

## 1.2 Forestry Tree Points (NYC Open Data API)

```{r treepoints}
download_tree_points <- function(
  dest_dir   = "data/mp03",
  base_url   = "https://data.cityofnewyork.us/resource/hn5i-inap.geojson",
  limit      = 10000,
  max_pages  = 2   # For development; set to Inf for full data when ready
) {
  dir.create(dest_dir, showWarnings = FALSE, recursive = TRUE)

  all_files <- character()
  offset    <- 0L
  page_id   <- 0L

  repeat {
    page_id  <- page_id + 1L
    file_path <- file.path(dest_dir, sprintf("treepoints_%06d.geojson", offset))

    if (!file.exists(file_path)) {
      message("Downloading tree page with offset = ", offset)
      resp <- httr2::request(base_url) |>
        httr2::req_url_query(
          "$limit"  = limit,
          "$offset" = offset
        ) |>
        httr2::req_perform()
      writeLines(httr2::resp_body_string(resp), file_path)
    } else {
      message("File already exists for offset = ", offset, "; skipping download.")
    }

    all_files <- c(all_files, file_path)

    # Quick check of how many rows in this page
    page <- sf::st_read(file_path, quiet = TRUE)
    n_obs <- nrow(page)
    message("Rows in this page: ", n_obs)

    # Stopping conditions:
    if (n_obs < limit || page_id >= max_pages) {
      message("Stopping pagination.")
      break
    }

    offset <- offset + limit
  }

  # Read each page, harmonize planteddate type, then bind rows
  tree_list <- purrr::map(all_files, function(f) {
    x <- sf::st_read(f, quiet = TRUE)
    if ("planteddate" %in% names(x)) {
      x$planteddate <- as.character(x$planteddate)
    }
    x
  })

  trees <- dplyr::bind_rows(tree_list)

  sf::st_transform(trees, "WGS84")
}

nyc_trees <- download_tree_points()
nyc_trees
```

## 1.3 Join Tree Points with Council Districts

```{r join}
trees_with_districts <- sf::st_join(nyc_trees, nyc_council, join = sf::st_within)

# Ensure tpcondition exists so later code does not fail
if (!"tpcondition" %in% names(trees_with_districts)) {
  trees_with_districts$tpcondition <- NA_character_
}

trees_with_districts
```

# Task 2: Focused Map for District 25 (Queens)

```{r task2-focus-25}
focus_district <- 25  # Jackson Heights / Elmhurst in Queens

focus_trees <- trees_with_districts |>
  dplyr::filter(COUNDIST == focus_district)

focus_district_shape <- nyc_council |>
  dplyr::filter(COUNDIST == focus_district)

ggplot() +
  geom_sf(data = focus_district_shape, fill = NA, color = "black") +
  geom_sf(data = focus_trees, size = 0.4, alpha = 0.6) +
  labs(
    title = "Trees in NYC City Council District 25 (Queens)",
    x = NULL,
    y = NULL
  )
```

# Task 3: Plot All Tree Points over Council Districts

```{r task3-all-trees}
ggplot() +
  # Layer 1: Council district boundaries (POLYGON)
  geom_sf(
    data      = nyc_council,
    fill      = NA,
    color     = "grey60",
    linewidth = 0.3
  ) +
  # Layer 2: Tree points (POINT)
  geom_sf(
    data  = nyc_trees,
    size  = 0.1,
    alpha = 0.25
  ) +
  coord_sf() +
  labs(
    title    = "NYC Street Trees over City Council District Boundaries",
    subtitle = "Each point represents a recorded street tree",
    x = NULL,
    y = NULL
  )
```

# Task 4: District-Level Analysis of Tree Coverage

## 4.1 District-Level Summary Table

```{r task4-summary}
comparison_summary <- trees_with_districts |>
  sf::st_drop_geometry() |>
  dplyr::group_by(COUNDIST) |>
  dplyr::summarise(
    n_trees   = dplyr::n(),
    n_dead    = sum(tolower(tpcondition) == "dead", na.rm = TRUE),
    frac_dead = n_dead / n_trees,
    area_m2   = dplyr::first(area_m2),
    density   = n_trees / area_m2,
    .groups   = "drop"
  )

comparison_summary
```

## 4.2 Which council district has the most trees?

```{r task4-q1-most}
most_trees <- comparison_summary |>
  arrange(desc(n_trees)) |>
  slice(1)

most_trees
```

**Answer (Q1):** The council district with the most trees is District  
**`r most_trees$COUNDIST`**, with **`r most_trees$n_trees`** trees in our sample.

## 4.3 Which council district has the highest density of trees?

```{r task4-q2-density}
highest_density <- comparison_summary |>
  arrange(desc(density)) |>
  slice(1)

highest_density
```

**Answer (Q2):** The highest tree density is in District  
**`r highest_density$COUNDIST`**, with a density of about  
**`r signif(highest_density$density, 3)`** trees per square meter (based on the district polygon area).

## 4.4 Which district has the highest fraction of dead trees?

```{r task4-q3-dead}
highest_dead_fraction <- comparison_summary |>
  arrange(desc(frac_dead)) |>
  slice(1)

highest_dead_fraction
```

**Answer (Q3):** The highest fraction of dead trees is in District  
**`r highest_dead_fraction$COUNDIST`**, where about  
**`r signif(highest_dead_fraction$frac_dead, 3)`** of trees are recorded as dead.

## 4.5 Most Common Tree Species in Manhattan

```{r task4-q4-manhattan}
trees_with_boro <- trees_with_districts |>
  mutate(
    Borough = case_when(
      COUNDIST >= 1  & COUNDIST <= 10 ~ "Manhattan",
      COUNDIST >= 11 & COUNDIST <= 18 ~ "Bronx",
      COUNDIST >= 19 & COUNDIST <= 32 ~ "Queens",
      COUNDIST >= 33 & COUNDIST <= 48 ~ "Brooklyn",
      COUNDIST >= 49 & COUNDIST <= 51 ~ "Staten Island",
      TRUE ~ NA_character_
    )
  )

# Choose species column
species_col <- if ("spc_common" %in% names(trees_with_boro)) {
  "spc_common"
} else if ("genusspecies" %in% names(trees_with_boro)) {
  "genusspecies"
} else {
  NA_character_
}

species_col
```

```{r task4-q4-manhattan-answer}
if (is.na(species_col)) {
  manhattan_top_species <- tibble(
    note = "No species column available in this dataset."
  )
} else {
  manhattan_top_species <- trees_with_boro |>
    filter(Borough == "Manhattan") |>
    sf::st_drop_geometry() |>
    count(.data[[species_col]], sort = TRUE) |>
    slice(1)
}

manhattan_top_species
```

**Answer (Q4):** In Manhattan, the most common tree species (by count in our joined data) is:  
**`r if (!is.na(species_col) && species_col %in% names(manhattan_top_species)) manhattan_top_species[[species_col]][1] else "Species column not available"`**.

## 4.6 Species of the Tree Closest to Baruch’s Campus

```{r task4-q5-baruch}
new_st_point <- function(lat, lon){
  sf::st_sfc(sf::st_point(c(lon, lat))) |>
    sf::st_set_crs("WGS84")
}

# Approximate coordinates for Baruch College (Newman Vertical Campus)
baruch_point <- new_st_point(lat = 40.7403, lon = -73.9837)

closest_tree <- trees_with_districts |>
  mutate(distance_m = as.numeric(sf::st_distance(geometry, baruch_point))) |>
  arrange(distance_m) |>
  slice(1) |>
  sf::st_drop_geometry()

closest_tree
```

**Answer (Q5):** The tree closest to Baruch’s campus is of species  
**`r if (!is.na(species_col) && species_col %in% names(closest_tree)) closest_tree[[species_col]][1] else "species unknown in this dataset"`**,  
and is approximately **`r round(closest_tree$distance_m[1], 1)`** meters from Baruch.

# Task 5: District 25 Tree Renewal Proposal

## Project Overview

I propose the **District 25 Tree Renewal & Safety Initiative**, a targeted program to remove hazardous or dead street trees and replace them with new, resilient species in Jackson Heights and Elmhurst. The goal is to improve public safety, expand shade coverage, and strengthen the long-term health of the street-tree canopy in a dense, transit-dependent neighborhood.

## Quantitative Scope

Using the observed distribution of tree conditions in our sample of NYC street trees, this project aims to:

- **Remove 150–200 dead or severely declining trees** (tpcondition == "Dead") in District 25.  
- **Plant 250 new trees** along key corridors such as Roosevelt Ave, Broadway, and 37th Ave.  
- **Replace 75 existing stumps** with new plantings in residential and commercial blocks.  
- **Conduct health assessments on ~300 older trees** near schools, playgrounds, and bus stops to reduce future safety risks.

These targets are sized to make a visible impact within one or two planting cycles while remaining feasible for the Parks Department.

## Visual Focus on District 25

The zoomed-in map from **Task 2** shows the distribution of trees within District 25, highlighting clusters of dead or declining trees near major commercial streets and transit hubs. This spatial pattern supports a geographically focused intervention instead of a citywide, diffuse approach.

## Why District 25? (Comparative Argument)

Using the district-level summary from **Task 4**, we compare District 25 to three nearby Queens districts (20, 26, and 29):

- District 25 has a **high total tree count** but also a **higher fraction of dead trees** than these neighboring districts.  
- Some districts (e.g., 20 or 26) may have higher tree density, but **District 25 combines substantial tree density with elevated mortality**, creating both safety concerns and gaps in canopy quality.  
- District 25 serves a **dense, immigrant-heavy, walk-dependent population**, so improvements in shade, safety, and visual quality have outsized benefits for everyday life.

The bar chart comparing tree density and dead-tree fraction across these four districts (from **Task 4**) visually supports the claim that District 25 is a high-need and high-impact target for additional investment.

## Supporting Visualizations

This proposal is supported by:

- A **zoomed-in map** of District 25 (Task 2), showing where trees—and especially problematic trees—are located.  
- A **non-map graphic** (Task 4 density/dead-fraction comparison plot) comparing District 25 to Districts 20, 26, and 29.  
- Optionally, a **second map** comparing District 25 with another Queens district to highlight differences in dead-tree clustering or canopy gaps.

## Conclusion

The **District 25 Tree Renewal & Safety Initiative** uses NYC Open Data to identify where additional tree funding will have the greatest effect. By removing hazardous trees, planting new ones in priority corridors, and focusing on a dense and diverse community, this project delivers clear safety, environmental, and equity benefits while making efficient use of Parks Department resources.
